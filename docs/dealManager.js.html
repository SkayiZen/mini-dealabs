<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: dealManager.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: dealManager.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file dealManager.js
 * @description G√®re la cr√©ation, la lecture, la recherche, la suppression et l‚Äôaffichage d√©taill√© des deals pour le projet Mini-Dealabs.
 * @module dealManager
 */

import inquirer from "inquirer";
import chalk from "chalk";
import fs from "fs";
import path from "path";
import { validatePrice } from "./validators.js";
import { logger } from "./logger.js";

// üìÅ D√©finition des chemins de donn√©es
const dataDir = path.resolve("data");
const dataPath = path.join(dataDir, "deals.json");

/**
 * Tableau contenant tous les deals charg√©s en m√©moire.
 * @type {Array&lt;Object>}
 */
export let deals = [];

/**
 * Charge les deals sauvegard√©s depuis le fichier JSON local.
 * Cr√©e automatiquement le dossier /data et le fichier deals.json s‚Äôils n‚Äôexistent pas.
 * @function
 * @returns {void}
 */
export function loadDeals() {
  try {
    if (!fs.existsSync(dataDir)) fs.mkdirSync(dataDir);
    if (fs.existsSync(dataPath)) {
      const rawData = fs.readFileSync(dataPath, "utf-8");
      deals = JSON.parse(rawData);
      logger.info(`${deals.length} deal(s) charg√©s depuis deals.json`);
    } else {
      deals = [];
      fs.writeFileSync(dataPath, "[]", "utf-8");
    }
  } catch (err) {
    logger.error(`Erreur lors du chargement des deals : ${err.message}`);
  }
}

/**
 * Sauvegarde la liste actuelle des deals dans le fichier JSON local.
 * @function
 * @returns {void}
 */
export function saveDeals() {
  try {
    fs.writeFileSync(dataPath, JSON.stringify(deals, null, 2), "utf-8");
    logger.info("Sauvegarde effectu√©e dans deals.json");
  } catch (err) {
    logger.error(`Erreur lors de la sauvegarde : ${err.message}`);
  }
}

/**
 * Cr√©e un nouveau deal √† partir des r√©ponses utilisateur (via CLI Inquirer).
 * Enregistre ensuite le deal dans le fichier local et journalise l‚Äôaction.
 * @async
 * @function
 * @returns {Promise&lt;void>}
 */
export async function createDeal() {
  try {
    const answers = await inquirer.prompt([
      { name: "title", message: "Titre du deal :" },
      { name: "description", message: "Description :" },
      { name: "initialPrice", message: "Prix initial :", validate: validatePrice },
      { name: "discountPrice", message: "Prix r√©duit :", validate: validatePrice },
      { name: "link", message: "Lien du deal :" },
      { name: "category", message: "Cat√©gorie :" },
    ]);

    const newDeal = {
      ...answers,
      score: 0,
      createdAt: new Date().toLocaleString(),
    };

    deals.push(newDeal);
    saveDeals();
    logger.info(`Nouveau deal ajout√© : ${answers.title}`);
    console.log(chalk.green("\nDeal ajout√© avec succ√®s !"));
  } catch (err) {
    logger.error(`Erreur lors de la cr√©ation : ${err.message}`);
  }
}

/**
 * Affiche la liste des deals tri√©s par score d√©croissant.
 * Inclut le calcul du pourcentage de r√©duction entre les prix.
 * @async
 * @function
 * @returns {Promise&lt;void>}
 */
export async function listDeals() {
  if (deals.length === 0) {
    console.log(chalk.red("Aucun deal enregistr√©."));
    return;
  }

  console.log(chalk.bold("\nListe des deals tri√©s par score :\n"));

  deals
    .sort((a, b) => b.score - a.score)
    .forEach((deal, i) => {
      const initial = Number(deal.initialPrice);
      const discount = Number(deal.discountPrice);

      let reduction = 0;
      if (initial > 0 &amp;&amp; discount > 0 &amp;&amp; discount &lt; initial) {
        reduction = Math.round(((initial - discount) / initial) * 100);
      }

      console.log(
        chalk.yellow.bold(`#${i + 1}`),
        chalk.bold(deal.title),
        "\n",
        chalk.gray(deal.description || "Pas de description"),
        "\n",
        chalk.whiteBright(`${initial.toFixed(2)}‚Ç¨ ‚Üí ${discount.toFixed(2)}‚Ç¨`) +
          (reduction > 0
            ? chalk.green(` (-${reduction}%)`)
            : chalk.dim(" (Aucune r√©duction)")),
        "\n",
        chalk.cyan(`Cat√©gorie : ${deal.category}`),
        "\n",
        chalk.magenta(`Score : ${deal.score}`),
        "\n",
        chalk.gray(`Ajout√© le ${deal.createdAt}`),
        "\n" + chalk.dim("‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
      );
    });
}

/**
 * Permet √† l‚Äôutilisateur de s√©lectionner une cat√©gorie existante
 * et affiche tous les deals correspondants.
 * @async
 * @function
 * @returns {Promise&lt;void>}
 */
export async function searchDeal() {
  if (deals.length === 0) {
    console.log(chalk.red("Aucun deal disponible."));
    return;
  }

  const categories = [...new Set(deals.map((d) => d.category))];

  if (categories.length === 0) {
    console.log(chalk.red("Aucune cat√©gorie trouv√©e dans les deals."));
    return;
  }

  const { choice } = await inquirer.prompt([
    {
      type: "list",
      name: "choice",
      message: "Choisissez une cat√©gorie √† afficher :",
      choices: [
        ...categories.map((cat) => ({ name: cat, value: cat })),
        new inquirer.Separator(),
        { name: "Retour", value: "back" },
      ],
    },
  ]);

  if (choice === "back") {
    console.log(chalk.gray("Retour au menu principal..."));
    return;
  }

  const results = deals.filter(
    (d) => d.category.toLowerCase() === choice.toLowerCase()
  );

  if (results.length === 0) {
    console.log(chalk.red("Aucun deal trouv√© pour cette cat√©gorie."));
    return;
  }

  console.log(chalk.bold(`\nDeals trouv√©s dans la cat√©gorie "${choice}" :\n`));

  results
    .sort((a, b) => b.score - a.score)
    .forEach((deal, i) => {
      const initial = Number(deal.initialPrice);
      const discount = Number(deal.discountPrice);
      const reduction =
        initial > 0 &amp;&amp; discount > 0 &amp;&amp; discount &lt; initial
          ? Math.round(((initial - discount) / initial) * 100)
          : 0;

      console.log(
        chalk.yellow(`#${i + 1}`),
        chalk.bold(deal.title),
        "\n",
        chalk.gray(deal.description || "Pas de description"),
        "\n",
        `${initial.toFixed(2)}‚Ç¨ ‚Üí ${discount.toFixed(2)}‚Ç¨` +
          (reduction > 0
            ? chalk.green(` (-${reduction}%)`)
            : chalk.dim(" (Aucune r√©duction)")),
        "\n",
        `Score : ${deal.score}`,
        "\n",
        chalk.gray(`Ajout√© le ${deal.createdAt}`),
        "\n" + chalk.dim("----------------------------------------")
      );
    });

  console.log(
    chalk.gray(
      `\nTotal : ${results.length} deal(s) dans la cat√©gorie "${choice}".`
    )
  );
}

/**
 * Affiche les d√©tails complets d‚Äôun deal choisi par l‚Äôutilisateur.
 * @async
 * @function
 * @returns {Promise&lt;void>}
 */
export async function showDealDetails() {
  if (deals.length === 0) {
    console.log(chalk.red("Aucun deal enregistr√©."));
    return;
  }

  const { index } = await inquirer.prompt([
    {
      type: "list",
      name: "index",
      message: "Choisissez un deal √† afficher :",
      choices: [
        ...deals.map((d, i) => ({
          name: `${d.title} (Score : ${d.score})`,
          value: i,
        })),
        new inquirer.Separator(),
        { name: "Retour", value: "back" },
      ],
    },
  ]);

  if (index === "back") {
    console.log(chalk.gray("Retour au menu principal..."));
    return;
  }

  const deal = deals[index];
  const initial = Number(deal.initialPrice);
  const discount = Number(deal.discountPrice);
  const reduction =
    initial > 0 &amp;&amp; discount > 0 &amp;&amp; discount &lt; initial
      ? Math.round(((initial - discount) / initial) * 100)
      : 0;

  console.clear();
  console.log(chalk.cyan("========================================"));
  console.log(chalk.bold(deal.title));
  console.log(chalk.cyan("========================================\n"));

  console.log(`Description : ${deal.description || "Aucune"}`);
  console.log(`Cat√©gorie : ${deal.category}`);
  console.log(`Score : ${deal.score}`);
  console.log(`Prix initial : ${initial.toFixed(2)} ‚Ç¨`);
  console.log(`Prix r√©duit : ${discount.toFixed(2)} ‚Ç¨`);
  console.log(
    reduction > 0 ? chalk.green(`R√©duction : -${reduction}%`) : "R√©duction : 0%"
  );
  console.log(`Date d‚Äôajout : ${deal.createdAt}`);
  console.log(`Lien : ${deal.link || "Aucun lien fourni"}`);

  console.log("\n----------------------------------------\n");

  await inquirer.prompt([
    {
      type: "input",
      name: "back",
      message: chalk.gray("Appuyez sur Entr√©e pour revenir au menu principal..."),
    },
  ]);
}

/**
 * Supprime un deal choisi par l‚Äôutilisateur apr√®s confirmation.
 * Met √† jour le fichier JSON et journalise l‚Äôaction.
 * @async
 * @function
 * @returns {Promise&lt;void>}
 */
export async function deleteDeal() {
  if (deals.length === 0) {
    console.log(chalk.red("Aucun deal √† supprimer."));
    return;
  }

  const { index } = await inquirer.prompt([
    {
      type: "list",
      name: "index",
      message: "Choisissez un deal √† supprimer :",
      choices: [
        ...deals.map((d, i) => ({
          name: `${d.title} (Score : ${d.score})`,
          value: i,
        })),
        new inquirer.Separator(),
        { name: "Retour", value: "back" },
      ],
    },
  ]);

  if (index === "back") {
    console.log(chalk.gray("Retour au menu principal..."));
    return;
  }

  const deal = deals[index];

  const { confirm } = await inquirer.prompt([
    {
      type: "confirm",
      name: "confirm",
      message: `Voulez-vous vraiment supprimer "${deal.title}" ?`,
      default: false,
    },
  ]);

  if (!confirm) {
    console.log(chalk.yellow("\nSuppression annul√©e."));
    return;
  }

  deals.splice(index, 1);
  saveDeals();

  logger.info(`Deal supprim√© : ${deal.title}`);
  console.log(chalk.green(`\n"${deal.title}" a √©t√© supprim√© avec succ√®s.`));
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-dealManager.html">dealManager</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Tue Oct 14 2025 11:03:26 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
